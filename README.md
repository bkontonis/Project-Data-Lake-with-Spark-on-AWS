# Project: Data Lake with Apache Spark on AWS

## Introduction
In this project, we try to help one music streaming startup, Sparkify, to move their date warehouse to a data lake. Their data resides in S3, in a directory of JSON logs on user activity on the app, as well as a directory with JSON metadata on the songs in their app.

As their data engineer, I am tasked with building an ETL pipeline that extracts their data from **S3**, processes them using **Spark**, and loads the data back into **S3** as a set of dimensional tables. This will allow their analytics team to continue finding insights in what songs their users are listening to.

To complete the project, I had to load data from S3, process the data into analytics tables using Spark, and load them back into S3. I **deployed this Spark process on a cluster using AWS**.

## Project Datasets
I'll be working with two datasets that reside in S3. Here are the S3 links for each:
- Song data: `s3://udacity-dend/song_data`
- Log data: `s3://udacity-dend/log_data`

### Song Dataset
The first dataset is a subset of real data from the [Million Song Dataset](https://labrosa.ee.columbia.edu/millionsong/). Each file is in JSON format and contains metadata about a song and the artist of that song. The files are partitioned by the first three letters of each song's track ID. For example, here are filepaths to two files in this dataset.

`song_data/A/B/C/TRABCEI128F424C983.json` <br>
`song_data/A/A/B/TRAABJL12903CDCF1A.json`

And below is an example of what a single song file, TRAABJL12903CDCF1A.json, looks like.

`{"num_songs": 1, "artist_id": "ARJIE2Y1187B994AB7", "artist_latitude": null, "artist_longitude": null, "artist_location": "", "artist_name": "Line Renaud", "song_id": "SOUPIRU12A6D4FA1E1", "title": "Der Kleine Dompfaff", "duration": 152.92036, "year": 0}`

### Log Dataset
The second dataset consists of log files in JSON format generated by this [event simulator](https://github.com/Interana/eventsim) based on the songs in the dataset above. These simulate app activity logs from an imaginary music streaming app based on configuration settings.

The log files in the dataset you'll be working with are partitioned by year and month. For example, here are filepaths to two files in this dataset.

`log_data/2018/11/2018-11-12-events.json` <br>
`log_data/2018/11/2018-11-13-events.json`

And below is an example of what the data in a log file, 2018-11-12-events.json, looks like.

![log-data.png](attachment:log-data.png)


## Solution
Using the song and event datasets, I'll need to create a star schema optimized for queries on song play analysis.
This includes the following tables.

### Fact Table
1. **songplays** - records in event data associated with song plays i.e. records with page `NextSong`
   - *songplay_id, start_time, user_id, level, song_id, artist_id, session_id, location, user_agent*

### Dimension Tables
2. **users** - users in the app
   - *user_id, first_name, last_name, gender, level*
3. **songs** - songs in music database
   - *song_id, title, artist_id, year, duration*
4. **artists** - artists in music database
   - *artist_id, name, location, lattitude, longitude*
5. **time** - timestamps of records in songplays broken down into specific units
   - *start_time, hour, day, week, month, year, weekday*

## AWS configurations and SETUP
### Step 1
- Create a new IAM user in your AWS account.
- Give it AdministratorAccess and Attach policies
- Use access key and secret key to create clients for EMR, S3, IAM.

### Step 2
- Create an IAM Role in order to be able to access S3 bucket

### Step 3
- Create an S3 bucket, which you will use to write the data after processing them with Spark

### Step 4
- Create an EMR Cluster

### Step 5
- Fill the config file with your "AWS_ACCESS_KEY_ID" and "AWS_SECRET_ACCESS_KEY" from the IAM user credentials from **Step 1**


## ETL Pipeline
- Read data from S3 bucket
- Process that data using Spark
- Write them back to S3

The project includes three files:
- `etl.py` reads data from S3, processes that data using Spark, and writes them back to S3
- `dl.cfg` in this file you have to enter your AWS credentials
- `README.md` provides the description of the project

## How to run
1. First, set up up your AWS account, IAM credentials and EMR cluster (create and launch). Also, create an S3 bucket, which you will use to write the data after processing them with Spark.
2. Second, enter your AWS credentials in the `dl.cfg` file
3. In the `etl.py` file, go to line 148, within the main function, and edit the output path (`output_data = 'enter_the_path_to_your_S3_bucket'`) in order to point it to your S3 bucket
4. Execute the following line on your terminal in to run the ETL pipeline:
   - `python3 etl.py`